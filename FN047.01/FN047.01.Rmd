---
title: "FN047.01"
author: "Francesco Neri"
date: "`r Sys.Date()`"
output: html_document
---

Analysis of FN047.01 (see details on [benchling](https://benchling.com/francesconeri/f/lib_zYqsGFL4-senescence-morphology-study/etr_1qDjrVUH-fn047-01_hmvecl_fs-ss_ir_dna-content-after-g1-enrichment/edit))

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# libraries

library(tidyverse)
library(devtools)
library(readxl)
library(openxlsx)
library(plater)
library(ggpubr)

# file paths to manually input

input_files <- tribble(
  ~IA_output_file_path, ~metadata_file_path,
  "C:/Users/ffran/Dropbox/R/Wirtz-collaboration/FN047.01/IAoutput_Mock.xlsx", "C:/Users/ffran/Dropbox/R/Wirtz-collaboration/FN047.01/IAoutput_Mock_metadata.csv",
  "C:/Users/ffran/Dropbox/R/Wirtz-collaboration/FN047.01/IAoutput_IR.xlsx", "C:/Users/ffran/Dropbox/R/Wirtz-collaboration/FN047.01/IAoutput_IR_metadata.csv"
)

# source functions

## default folder path for functions
functions_path <- "C:/Users/ffran/AppData/Local/R/functions"

## df with files to source and corresponding folder path
files_to_load <- tribble(
  ~file_name, ~file_path,
  "tidy_IAoutput.R",  functions_path,
  "merge_plate_metadata.R", functions_path
)

## get full paths to fils
files_to_load <- files_to_load %>%
  mutate(.,
       full_path = file.path(file_path, file_name)
       )

## source all files listed in files_to_load
for (full_path in files_to_load$full_path) {
  source(full_path)
}

# plots themes

old_theme <- theme_set(theme_bw())
theme_update(
  legend.title = element_text(size=12), #change legend title font size
  legend.text = element_text(size=10) #change legend text font size
)

```

## Load data

```{r load data}

# create function to load data (i.e. import IA output, tidy, merge with plate metadata)

load_data <- function(IA_output_file_path, metadata_file_path) {
  
  tidied_IAoutput <- tidy_IAoutput(file_path = IA_output_file_path)
  
  merge_plate_metadata(tidied_IAoutput_df = tidied_IAoutput,
                       metadata = metadata_file_path)
}

# load data from files listed in input_files

plates <- vector(mode = "list", length = nrow(input_files))

for (i in seq_along(input_files)) {
  plates[[i]] <- load_data(input_files$IA_output_file_path[i], input_files$metadata_file_path[i])
}

# merge data from multiple plates

df <- bind_rows(plates)

df

```

## G1/low vs G2/high DNA content threshold


```{r thresholds}

# select DAPI threshold value

df <- df %>%
  mutate(DAPI_threshold = ifelse(
    condition == "CTL",
    7500000, # added manually based on histogram
    10000000) # added manually based on histogram
  )

# conditions colors

fill_scale_conditions <- scale_fill_brewer(palette = "Dark2", limits = sort(unique(df$condition)))

# plot histogram DAPI staining + DAPI threshold

ggplot(df) +
  geom_histogram(
    aes(x = DAPI,
        fill = condition),
    bins = 100) +
  geom_vline(aes(xintercept = DAPI_threshold)) +
  facet_grid(condition ~ serum) +
  scale_x_continuous(limits = c(0,quantile(df$DAPI, 0.99))) +
  labs(y = "Counts",
       x = "DNA Content (integrated DAPI staining, A.U.)",
       fill = "Condition") +
  fill_scale_conditions


```


## G1/G2 proportion in SEN vs CTL cells


```{r G1 vs G2 proportions}

# add DNA content label (G1 vs G2) to df

df <- df %>%
  mutate(
    DNA_content = ifelse(DAPI > DAPI_threshold, "G2", "G1")
    )

# generate summary df with % of G1 and G2 cells per well

## df with tot cell counts per well

grouping_variables <- c("plate", "well", "condition", "serum")

df_tot_counts <- df %>%
  group_by_at(vars(all_of(grouping_variables))) %>%
  summarise(tot_count = n())

## df summary with G1 & G2 counts

df_G1_G2_counts <- df %>%
  group_by_at(vars(all_of(c(grouping_variables, "DNA_content")))) %>%
  summarise(sub_count = n())

## join dfs and calculate proportions

df_proportions <- left_join(df_G1_G2_counts, df_tot_counts) %>%
  mutate(proportion = sub_count / tot_count)

# plotting

## conditions colors

color_scale_conditions <- scale_color_brewer(palette = "Dark2", limits = sort(unique(df$condition)))

## stacked bar plot function

plot_G1_G2_percent_stacked <- function(df, bars, faceting) {
  
  # To enter column names as function arguments, those argument must
  ## 1) be quoted (with enquo())
  ## 2) be unquoted (with !!)
  
  bars <- enquo(bars) # quoting 
  faceting <- enquo(faceting) # quoting
  
  ggplot(data = df,
         aes(
           y = proportion,
           x = !!bars # unquoting
           )
         ) +
    geom_bar(aes(fill = DNA_content),
             position = "fill",
             stat = "identity"
             ) +
    geom_point(data = filter(df, DNA_content == "G2"),
               aes(color = condition),
               fill = "white",
               size = 3,
               shape = 21) +
    facet_grid(cols = vars(!!faceting)) + # unquoting
    labs(y = "% of Cells") +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0,1),
                       breaks = seq(0,1,length.out = 11)) +
    scale_fill_manual(values = c("lightgrey", "darkgrey")) +
    guides(fill = guide_legend(title = "DNA content")) +
    color_scale_conditions
}

## plots

plot_G1_G2_percent_stacked(df_proportions, bars = condition, faceting = serum)

plot_G1_G2_percent_stacked(df_proportions, bars = serum, faceting = condition)

```

It truly seems that the reduction in the fraction of G2 cells observed in CTL condition upon G1-enrichment (SS) is maintained after IR, potentially suggesting that truly DNA content at sen induction correlates with DNA content of cells once senescent

Is this reduction in the proportion of G2 cells statistically

## Stats

```{r stats proportions, fig.dim = c(4,4)}

# testing only G2 values (no sense in testing reciprocal as well)

df_proportions_G2 <- df_proportions %>%
  filter(DNA_content == "G2")

# generating dfs with only CTL or IR for serum comparison

df_proportions_G2_CTL <- df_proportions_G2 %>%
  filter(condition == "CTL")

df_proportions_G2_IR <- df_proportions_G2 %>%
  filter(condition == "IR")

# boxplots 

boxplot <- function(df, y, ylab) {
  
  y <- enquo(y) # quoting
  
  ggplot(data = df,
         aes(
           y = !!y, # unquoting
           x = serum
           )
         ) +
    geom_boxplot(aes(color = condition)) +
    geom_point(data = filter(df, DNA_content == "G2"),
               aes(color = condition),
               fill = "white",
               size = 3,
               shape = 21) +
    labs(y = ylab) +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0,1),
                       breaks = seq(0,2,length.out = 11)) +
    scale_fill_manual(values = c("lightgrey", "darkgrey")) +
    guides(fill = guide_legend(title = "DNA content")) +
    color_scale_conditions
}

# plot proportions 

boxplot(df_proportions_G2_IR, proportion, "% of G2 cells") +
  stat_compare_means(label.y = 0.9)

boxplot(df_proportions_G2_CTL, proportion, "% of G2 cells") +
  stat_compare_means(label.y = 0.9)


```

The reduction in % of G2 cells is indeed statistically significant.

While the exact proportions of G1 and G2 cells are not maintained after sen induction, are the relative fold change between FS and SS conditions maintained after IR?

```{r stats fold change of proportions, fig.dim = c(4,4)}

# generate df with means 

df_proportions_G2_mean <- df_proportions_G2 %>%
  group_by(condition, serum) %>%
  summarise(mean_prop = mean(proportion))

# add mean values to dfs

add_mean_foldchange <- function(df) {
  new_df <- df %>%
    left_join(df_proportions_G2_mean)
  
  lowest_mean <- new_df$mean_prop %>%
    unique() %>%
    min()
  
  new_df <- new_df %>%
    mutate(fold_change = proportion/lowest_mean)
}

CTL_foldchange <- add_mean_foldchange(df_proportions_G2_CTL)

IR_foldchange <- add_mean_foldchange(df_proportions_G2_IR)

# new boxplot function (no Y axis scaling nor limits)

boxplot_foldchange <- function(df, y, ylab, x = serum) {
  
  y <- enquo(y) # quoting
  x <- enquo(x) # quoting
  
  ggplot(data = df,
         aes(
           y = !!y, # unquoting
           x = !!x # unquoting
           )
         ) +
    geom_boxplot(aes(color = condition)) +
    geom_point(data = filter(df, DNA_content == "G2"),
               aes(color = condition),
               fill = "white",
               size = 3,
               shape = 21) +
    labs(y = ylab) +
    scale_fill_manual(values = c("lightgrey", "darkgrey")) +
    guides(fill = guide_legend(title = "DNA content")) +
    color_scale_conditions
}

# plot

boxplot_foldchange(CTL_foldchange, y = fold_change, ylab = "G2 % Fold Change") +
  stat_compare_means(label.y = 2.2, label.x = 1.5)

boxplot_foldchange(IR_foldchange, y = fold_change, ylab = "G2 % Fold Change") +
  stat_compare_means(label.y = 2.35, label.x = 1.5)

# df with both CTL and IR 

foldchange <- bind_rows(CTL_foldchange, IR_foldchange) %>%
  filter(serum == "FS")

boxplot_foldchange(foldchange, y = fold_change, ylab = "G2 % Fold Change", x = condition) +
  stat_compare_means(label.y = 2.35, label.x = 0.7)

```
It appears the relative fold change are very similar (~2x reduction in % of G2 cells). However, there's still a statistically significant difference in the relative reduction between CTL and IR, indicating that the fold change between FS and SS across the 2 conditions (CTL and IR) is not perfectly maintained.

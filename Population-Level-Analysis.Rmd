---
title: "Population-Level-Analysis"
author: "Francesco Neri"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE,
                      include = FALSE,
                      fig.align='center',
                      out.width="100%",
                      fig.width=7.5,
                      fig.asp=0.618)

# libraries
library(tidyverse)
library(broom)
library(patchwork)
library(readxl)
library(scales)
library(RColorBrewer)
library(ggsignif)

library(functions) # custom functions

theme_set(theme_bw())

```

```{r load data}

SABGal_EdU <- list(
  "FN027.01" = read.csv(
    here::here(
      "inst","extdata","FN027.01","Analysis_Report_2024-02-07.csv"
    )),
  "FN027.02" = read.csv(
    here::here(
      "inst","extdata","FN027.02","Analysis_Report_2024-02-07.csv"
    )),
  "FN027.03" = read.csv(
    here::here(
      "inst","extdata","FN027.03_230126","Analysis_Report_2024-02-07.csv"
    ))
)

ICC_Morph <- left_join(
  read_xlsx( 
    path = here::here(
      "inst","extdata","2023_1116_Analysis of Buck's images-v4_Mean Intensity.xlsx"
    )),
  read_xlsx(
    path = here::here(
      "inst","extdata","2024_0116_Analysis of Buck's images-v4 - speckle detection.xlsx"
    ))
)

```
# SA-$\beta$-Gal & EdU

```{r df_SABGal_EdU}

# adjust FN27.01
SABGal_EdU$FN027.01 <- SABGal_EdU$FN027.01 %>%
  mutate(
    Condition = str_replace_all(Condition, "_background", "")
  )

df_SABGal_EdU <- SABGal_EdU %>%
  # add the df name as variable to each df
  imap(
    # .x indicates the list object
    ~ .x %>%
      mutate(
        # .y indicates the object name
        Dataset = .y,
        # adjust Dataset labels
        Dataset = str_replace_all(Dataset,
                                  pattern = c("FN027.03" = "3", "FN027.02" = "2", "FN027.01" = "1"))
      ) %>% 
      # reorder cols
      select(Dataset, everything())
    ) %>%
  # merge the two dfs
  bind_rows() %>%
  # remove background wells
  filter(!str_detect(Condition, pattern = "_background")) %>%
  mutate(
    # create fct column that combines condition_serum to assign colors
    Serum_Condition = paste0(Serum, " ", Condition),
    Serum_Condition = factor(Serum_Condition, levels = c("SS CTL", "FS CTL", "SS IR", "FS IR")),
    # turn Dataset, Condition, Serum, and Cell.Type into factors
    Dataset = factor(Dataset),
    Condition = factor(Condition, levels = c("CTL", "IR")),
    Serum = factor(Serum, levels = c("FS", "SS")),
    Cell.Type = factor(Cell.Type, levels = c("HMVEC-L", "IMR-90")),
    # turn percentages into proportions
    across(contains("percentage"), ~ . / 100)
  ) %>%
  # reorder cols
  select(1:grep("Serum", colnames(.)), Serum_Condition, everything()) %>%
  # turn data.frame into tibble
  tibble()

df_SABGal_EdU_summary <- df_SABGal_EdU %>%
  # calculate mean & SD
  group_by(Dataset, plate, Condition, Serum, Serum_Condition, Cell.Type) %>%
  summarise(
    `mean_EdU_median` = mean(EdU_median),
    `sd_EdU_median` = sd(EdU_median),
    `mean_SABGal_median` = mean(SABGal_median),
    `sd_SABGal_median` = sd(SABGal_median),
  ) %>%
  ungroup()

df_SABGal_EdU_summary_all_datasets <- df_SABGal_EdU %>%
  # calculate mean & SD
  group_by(Condition, Serum, Serum_Condition, Cell.Type) %>%
  summarise(
    `mean_EdU_median` = mean(EdU_median),
    `sd_EdU_median` = sd(EdU_median),
    `mean_SABGal_median` = mean(SABGal_median),
    `sd_SABGal_median` = sd(SABGal_median),
  ) %>%
  ungroup()

df_SABGal_EdU_summary_split <- df_SABGal_EdU_summary %>%
  split(.$Dataset)

```
## SABGal & EdU images

```{r panel SABGal EdU grid, include=TRUE}

plot_grid_SABGal_EdU <- function(data) {
  ggplot(data,
         aes(x = Cell.Type,
             y = Condition)) +
    geom_tile(color = "black",
              fill = "white") +
    geom_text(label = "image",
              size = 4) +
    # facet_grid(. ~ Cell.Type) +
    labs(x = NULL,
         y = NULL) +
    scale_x_discrete(position = "top") +
    theme_minimal()
}

grid_SABGal_EdU <- plot_grid_SABGal_EdU(df_SABGal_EdU_summary)

grid_SABGal_EdU_FS <- plot_grid_SABGal_EdU(df_SABGal_EdU_summary %>%
                                             filter(Serum == "FS"))
  # theme(axis.text.x = element_blank())

grid_SABGal_EdU_FS + labs(title = "FS only images")

```


## SABGal & EdU data

```{r function plot SABGal_EdU}

plot_SABGal_EdU_summary <- function(data) {
  
  stopifnot(is.data.frame(data))
  
  # palette
  palette <- RColorBrewer::brewer.pal(12, "Paired") %>% .[c(1,2,5,6)]
  
  palette_greys <- c(`3` = "#000000", `2` = "#737373", `1` = "#CCCCCC")
  
  
  ggplot(data,
         aes(x = `mean_SABGal_median`,
             y = `mean_EdU_median`,
             fill = Serum_Condition)
         ) +
    # EdU error bars
    geom_errorbar(aes(ymin = `mean_EdU_median` - `sd_EdU_median`,
                      ymax = `mean_EdU_median` + `sd_EdU_median`)
                  ) +
    # SABGal error bars
    geom_errorbar(aes(xmin = `mean_SABGal_median` - `sd_SABGal_median`,
                      xmax = `mean_SABGal_median` + `sd_SABGal_median`),
                  ) +
    geom_point(
      aes(shape = Cell.Type,
          color = Dataset),
      size = 1.5,
      stroke = 1.2
    ) +
    facet_grid(Serum ~ Cell.Type) +
    scale_fill_manual(values = palette) +
    scale_color_manual(values = palette_greys) +
    scale_shape_manual(values = c(22,24)) +
    labs(x = expression("SA-" *beta* "-Gal Optical Density"),
         y = "EdU Intensity (AU)") +
    guides(shape = guide_legend(order = 1, override.aes = list(stroke=0.5,size=2),
                                title = "Cell Type"),
           fill = guide_legend(order = 2,
                               title = "Condition",
                               # needed to fix a legend bug due to use of scale_shape_manual()
                               override.aes = list(shape=21,
                                                   size=3,
                                                   stroke=0.5)),
           color = guide_legend(order = 3,
                                # needed to fix a legend bug due to use of scale_shape_manual()
                                override.aes = list(shape=21,
                                                    size=2))
           )
}

```

```{r function plot SABGal_EdU all datasets}

plot_SABGal_EdU_summary_all_datasets <- function(data) {
  
  stopifnot(is.data.frame(data))
  
  # palette
  palette <- RColorBrewer::brewer.pal(12, "Paired") %>% .[c(1,2,5,6)]
  
  palette_greys <- c(`3` = "#000000", `2` = "#737373", `1` = "#CCCCCC")
  
  
  ggplot(data,
         aes(x = `mean_SABGal_median`,
             y = `mean_EdU_median`,
             fill = Serum_Condition)
         ) +
    # EdU error bars
    geom_errorbar(aes(ymin = `mean_EdU_median` - `sd_EdU_median`,
                      ymax = `mean_EdU_median` + `sd_EdU_median`),
                  ) +
    # SABGal error bars
    geom_errorbar(aes(xmin = `mean_SABGal_median` - `sd_SABGal_median`,
                      xmax = `mean_SABGal_median` + `sd_SABGal_median`),
                  ) +
    geom_point(
      aes(shape = Cell.Type),
      size = 1.5
    ) +
    facet_grid(Serum ~ Cell.Type) +
    ## for % plots
    # scale_x_continuous(limits = c(0,1),
    #                    labels = scales::percent) +
    # scale_y_continuous(limits = c(0,1),
    #                    labels = scales::percent) +
    scale_fill_manual(values = palette) +
    scale_color_manual(values = palette_greys) +
    scale_shape_manual(values = c(22,24)) +
    ## for shape = Cell.Type
    # scale_shape_manual(values = c("HMVEC-L" = 21, "IMR-90" = 24)) +
    labs(x = expression("SA-" *beta* "-Gal Optical Density"),
         y = "EdU Intensity (AU)") +
    guides(shape = guide_legend(order = 1, override.aes = list(stroke=0.5,size=2),
                                title = "Cell Type"),
           fill = guide_legend(order = 2,
                               title = "Condition",
                               # needed to fix a legend bug due to use of scale_shape_manual()
                               override.aes = list(shape=21,
                                                   size=3,
                                                   stroke=0.5)),
           color = guide_legend(order = 3,
                                # needed to fix a legend bug due to use of scale_shape_manual()
                                override.aes = list(shape=21,
                                                    size=2))
           )
}

```

### Split datasets

```{r plot SABGal & EdU split, include=TRUE}

map(df_SABGal_EdU_summary_split,
    plot_SABGal_EdU_summary)

```

### Datasets - mean ± SD

Both FS & SS

```{r plot SABGal & EdU, include=TRUE}

# filtering: NOT 1
SABGal_EdU_summary <- plot_SABGal_EdU_summary(df_SABGal_EdU_summary)
SABGal_EdU_summary + labs(title = "Serum: FS & SS; Faceting: cell type x serum")

## faceting: Cell type only
SABGal_EdU_summary +
  facet_grid(. ~ Cell.Type) +
  labs(title = "Serum: FS & SS; Faceting: cell type")

## faceting: Serum only
SABGal_EdU_summary +
  facet_grid(. ~ Serum) +
  labs(title = "Serum: FS & SS; Faceting: serum")

## faceting: none
SABGal_EdU_summary +
  facet_grid() +
  labs(title = "Serum: FS & SS; Faceting: none")

```

```{r plot SABGal & EdU all datasets, include=TRUE}

SABGal_EdU_summary_all_datasets <- plot_SABGal_EdU_summary_all_datasets(
  df_SABGal_EdU_summary_all_datasets
  )

SABGal_EdU_summary_all_datasets +
  labs(title = "Serum: FS & SS; Faceting: cell type x serum")

## faceting: Cell type only
SABGal_EdU_summary_all_datasets +
  facet_grid(. ~ Cell.Type) +
  labs(title = "Serum: FS & SS; Faceting: cell type")

## faceting: Serum only
SABGal_EdU_summary_all_datasets +
  facet_grid(. ~ Serum) +
  labs(title = "Serum: FS & SS; Faceting: serum")

## faceting: none
SABGal_EdU_summary_all_datasets +
  facet_grid() +
  labs(title = "Serum: FS & SS; Faceting: none")

```


Only FS

```{r plot SABGal & EdU FS only, include=TRUE, message=FALSE}

# filtering: FS only
FS_only_summary <- plot_SABGal_EdU_summary(df_SABGal_EdU_summary %>%
                             filter(Serum == "FS")
                           ) +
  # change fill palette
  scale_fill_manual(values = RColorBrewer::brewer.pal(12, "Accent")) +
  # remove Serum faceting
  facet_grid(. ~ Cell.Type)
  
FS_only_summary +
  labs(title = "Serum: FS; Faceting: cell type")

## faceting: none
FS_only_summary +
  facet_grid() +
  labs(title = "Serum: FS; Faceting: none")

```

```{r plot SABGal & EdU all datasets FS only, include=TRUE, message=FALSE}

# filtering: FS only
FS_only_summary_all_datasets <- plot_SABGal_EdU_summary_all_datasets(
  df_SABGal_EdU_summary_all_datasets %>%
    filter(Serum == "FS")
  ) +
  # change fill palette
  scale_fill_manual(values = RColorBrewer::brewer.pal(12, "Accent")) +
  # remove Serum faceting
  facet_grid(. ~ Cell.Type)
  
FS_only_summary_all_datasets +
  labs(title = "Serum: FS; Faceting: cell type")

## faceting: none
FS_only_summary_all_datasets +
  facet_grid() +
  labs(title = "Serum: FS; Faceting: none")

```


### Datasets - all data points

```{r function plot SABGal_EdU all datapoints}

plot_SABGal_EdU <- function(data) {
  
  stopifnot(is.data.frame(data))
  
  # palette
  palette <- RColorBrewer::brewer.pal(12, "Paired") %>% .[c(1,2,5,6)]
  
  palette_greys <- c(`3` = "#000000", `2` = "#737373", `1` = "#CCCCCC")
  
  
  ggplot(data,
         aes(x = `SABGal_median`,
             y = `EdU_median`,
             fill = Serum_Condition)
         ) +
    geom_point(
      aes(shape = Cell.Type,
          color = Dataset),
      size=1.5, alpha=1/1.2,
      stroke = 1.2
    ) +
    facet_grid(Serum ~ Cell.Type) +
    scale_fill_manual(values = palette) +
    scale_color_manual(values = palette_greys) +
    scale_shape_manual(values = c(22,24)) +
    labs(x = expression("SA-" *beta* "-Gal Optical Density"),
         y = "EdU Intensity (AU)") +
    guides(shape = guide_legend(order = 1, override.aes = list(stroke=0.5,size=2),
                                title = "Cell Type"),
           fill = guide_legend(order = 2,
                               title = "Condition",
                               # needed to fix a legend bug due to use of scale_shape_manual()
                               override.aes = list(shape=21,
                                                   size=3,
                                                   stroke=0.5)),
           color = guide_legend(order = 3,
                                # needed to fix a legend bug due to use of scale_shape_manual()
                                override.aes = list(shape=21,
                                                    size=2))
           )
}

```

Both FS & SS

```{r plot SABGal & EdU all datapoints, include=TRUE}

# filtering: NOT 1
SABGal_EdU <- plot_SABGal_EdU(df_SABGal_EdU)
SABGal_EdU + labs(title = "Serum: FS & SS; Faceting: cell type x serum")

## faceting: Cell type only
SABGal_EdU +
  facet_grid(. ~ Cell.Type) +
  labs(title = "Serum: FS & SS; Faceting: cell type")

## faceting: Serum only
SABGal_EdU +
  facet_grid(. ~ Serum) +
  labs(title = "Serum: FS & SS; Faceting: serum")

## faceting: none
SABGal_EdU + facet_grid() +
  labs(title = "Serum: FS & SS; Faceting: none")

```

Only FS

```{r plot SABGal & EdU FS only all datapoints, include=TRUE, message=FALSE}

# filtering: FS only
FS_only <- plot_SABGal_EdU(df_SABGal_EdU %>%
                             filter(Serum == "FS")
                           ) +
  # change fill palette
  scale_fill_manual(values = RColorBrewer::brewer.pal(12, "Accent")) +
  # remove Serum faceting
  facet_grid(. ~ Cell.Type)
  
FS_only +
  labs(title = "Serum: FS; Faceting: cell type")

## faceting: none
FS_only +
  facet_grid() +
  labs(title = "Serum: FS; Faceting: none")

```

#### Single marker plots

```{r df_single_marker}

df_single_marker <- df_SABGal_EdU %>%
  # remove dataset 1, because it didn't have enough cells
  filter(Dataset != "1") %>%
  # split df based on Serum
  group_by(Serum) %>%
  nest()%>%
  # re-add Serum as variable in split df
  # Serum will be needed for faceting within the plot function
  mutate(
    data = map(data, ~ bind_cols(Serum = first(Serum), .x))
  )

# add FS + SS dataset
FS_SS <- tibble(
  Serum = "FS_SS",
  data = df_SABGal_EdU %>%
    # remove dataset 1, because it didn't have enough cells
    filter(Dataset != "1") %>%
    list()
)

df_single_marker <- df_single_marker %>%
  dplyr::bind_rows(FS_SS)

```

```{r function calculate_test_results}

calculate_test_results <- function(data, variables, grouping) {
  
  stopifnot(is.data.frame(data))
  stopifnot(is.character(variables))
  stopifnot(is.character(grouping))
  
  df <- data %>%
    group_by(!!!syms(grouping)) %>%
    summarise(
      across(all_of(variables),
             ~ list(tidy(
               wilcox.test(.x ~ Condition,
                           exact = FALSE) # same as default, but prevents warning
             ))
             ),
      .groups = "drop"
    ) %>%
    pivot_longer(cols = !any_of(grouping), names_to = "Variable", values_to = "Test_Results") %>%
    # adjust p values for multiple comparisons by FDR
    unnest(Test_Results) %>%
    ## group by: Variable and grouping variable outside of Cell.Type and Serum
    group_by(
      !!!syms(c(grouping[!str_detect(grouping, "Cell.Type|Serum")], "Variable"))
    ) %>%
    mutate(
      p_adj = p.adjust(p.value, method = "BH"),
      # add annotation col
      annotation = case_when(
        p_adj < 0.0001 ~ "****",
        p_adj < 0.001 ~ "***",
        p_adj < 0.01 ~ "**",
        p_adj < 0.05 ~ "*",
        TRUE ~ sprintf("%.3f", p_adj)
      )
    ) %>%
    ungroup()
  
  # return df
  df
  
}

```

```{r function calculate_annotation_position}

calculate_annotation_position <- function(test_results_df, original_df, grouping) {
  
  # get variables to calculate the max value of
  Variables <- test_results_df$Variable %>% unique()
  
  # calculate max value of all Variables for each grouped subset
  max_values <- original_df %>%
    # calculate 
    group_by(!!!syms(grouping)) %>%
    summarise(
      across(.cols = all_of(Variables),
             .fns = max)
    ) %>%
    pivot_longer(cols = !any_of(grouping),
                 names_to = "Variable",
                 values_to = "ymax")
  
  df <- test_results_df %>%
    mutate(
      # calculate x coordinates
      x_position = as.integer(Cell.Type)  
    ) %>%
    # add ymax values
    left_join(max_values) %>%
    # simplify df
    select(1:which(names(.) == "Variable"), p.value, which(names(.) == "p_adj"):length(names(.)))
  
  # return df
  df
}

```


```{r stats df_single_marker}

# Compare IR vs CTL samples 
SABGal_EdU_test_results <- df_single_marker %>%
  # select df with both FS and SS
  filter(Serum == "FS_SS") %>%
  .$data %>%
  .[[1]] %>%
  # turn categorical variables into factors
  mutate(
    # Condition
    Condition = factor(Condition),
    # Serum
    Serum = factor(Serum),
    # Cell.Type
    Cell.Type = factor(Cell.Type),
  ) %>%
  # calculate adj-pvalues
  calculate_test_results(
    data = .,
    variables = c("EdU_median", "SABGal_median"),
    grouping = c("Serum", "Cell.Type")
  ) %>%
  # calculate x:y coordinates for stat annotations
  calculate_annotation_position(
    test_results_df = .,
    original_df = df_single_marker %>%
      # select df with both FS and SS
      filter(Serum == "FS_SS") %>%
      .$data %>%
      .[[1]],
    grouping = c("Serum", "Cell.Type")
  )

SABGal_EdU_test_results

```


```{r function plot single marker}

plot_single_marker <- function(data, y, ylab, title, test_results, ymax_multiplier = 1.1) {
  
  # palette
  palette <- RColorBrewer::brewer.pal(9, "Set1") %>% .[c(3:4)]
  
  # generate summary data for geom_col
  summary_data <- data %>%
    group_by(Cell.Type, Condition, Serum) %>%
    mutate(median = median(!!sym(y)),
           mean = mean(!!sym(y)),
           sd = sd(!!sym(y)))
  
  # adjust test_results based on selected y/variable
  test_results <- test_results %>%
    filter(
      # filter for Variable
      Variable == y,
      # filter for Serum groups present in data
      Serum %in% unique(data$Serum)
    )
  ## filter for Channel 3 groups if present in data
    if (any(names(test_results) %in% "Channel3")) {
       test_results <- test_results %>%
         filter(Channel3 %in% unique(data$Channel3))
    }
  
  # calculate absolute value to nudge ymax by
  ymax_nudge <- test_results %>%
    # filter for highest ymax value
    filter(ymax == max(ymax)) %>%
    mutate(
      # apply ymax_multiplier
      ymax_adjusted = ymax * ymax_multiplier,
      ymax_nudge = ymax_adjusted - ymax
    ) %>%
    .$ymax_nudge

  # plot
  p <- ggplot(data,
              aes(y = !!sym(y),
              x = Cell.Type)
              ) +
    geom_col(data = summary_data,
             aes(x = Cell.Type,
                 y = mean,
                 fill = Condition),
             color = "black",
             # fill = "white",
             width = 0.7,
             position = position_dodge(width = 0.8)) +
    geom_point(alpha=1/1.2,
               shape = 21,
               aes(fill = Condition),
               position = position_jitterdodge(dodge.width = 0.8,
                                               jitter.width = 0.5, jitter.height = 0)
               ) +
    # add stats
    ## line
    geom_segment(
      data = test_results,
      aes(x = x_position-0.2, xend = x_position+0.2,
          y = ymax + ymax_nudge)
      ) +
    ## label
    geom_text(
      data = test_results,
      aes(x = x_position,
          y = ymax + ymax_nudge,
          label = annotation
          ),
      size = 3, vjust = -0.5
    ) +
    facet_grid(. ~ Serum) +
    coord_cartesian(ylim = c(NA, test_results$ymax %>% max(.) * (ymax_multiplier + 0.2))) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    labs(title = title,
         y = ylab) +
    guides(color = guide_legend(override.aes = list(shape=21))) +
    theme(plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank())
  
  # print plot
  p
  
  # # adjust background colors of facets
  # g <- ggplot_gtable(ggplot_build(p))
  # strip_both <- which(grepl('strip-', g$layout$name))
  # fills <- c("#FFF380","#FFFFC2")
  # k <- 1
  # for (i in strip_both) {
  # j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  # g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  # k <- k+1
  # }
  # grid.draw(g)
}

```

```{r function plot single marker log10}

plot_single_marker_log10 <- function(data, y, ylab, title, test_results, ymax_multiplier = 2.0) {
  
  # palette
  palette <- RColorBrewer::brewer.pal(9, "Set1") %>% .[c(3:4)]
  
  # generate summary data for geom_col
  summary_data <- data %>%
    group_by(Cell.Type, Condition, Serum) %>%
    mutate(median = median(!!sym(y)),
           mean = mean(!!sym(y)),
           sd = sd(!!sym(y)))
  
  # adjust test_results based on selected y/variable
  test_results <- test_results %>%
    filter(
      # filter for Variable
      Variable == y,
      # filter for Serum groups present in data
      Serum %in% unique(data$Serum)
    )
  ## filter for Channel 3 groups if present in data
    if (any(names(test_results) %in% "Channel3")) {
       test_results <- test_results %>%
         filter(Channel3 %in% unique(data$Channel3))
    }
  
  # calculate adjusted ymax to plot stats (geom segment & text)
  test_results <- test_results %>%
    mutate(
      ymax_adjusted = ymax * 10^(ymax_multiplier-1)
    )
  
  # plot
  p <- ggplot(data,
              aes(y = !!sym(y),
              x = Cell.Type)
              ) +
    geom_col(data = summary_data,
             aes(x = Cell.Type,
                 y = median,
                 fill = Condition),
             color = "black",
             # fill = "white",
             width = 0.7,
             position = position_dodge(width = 0.8)) +
    geom_point(size=2,
               alpha=1/1.2,
               shape = 21,
               aes(fill = Condition),
               position = position_jitterdodge(dodge.width = 0.8,
                                               jitter.width = 0.5, jitter.height = 0)
               ) +
    # add stats
    ## line
    geom_segment(
      data = test_results,
      aes(x = x_position-0.2, xend = x_position+0.2,
          y = ymax_adjusted)
      ) +
    ## label
    geom_text(
      data = test_results,
      aes(x = x_position,
          y = ymax_adjusted,
          label = annotation
          ),
      size = 3, vjust = -0.5
    ) +
    facet_grid(. ~ Serum) +
    scale_color_manual(values = palette) +
    scale_fill_manual(values = palette) +
    scale_y_continuous(transform = "log10") +
    coord_cartesian(ylim = c(NA, test_results$ymax %>% max(.) * 10^(ymax_multiplier+0.5))) +
    labs(title = title,
         y = ylab) +
    guides(color = guide_legend(override.aes = list(shape=21))) +
    theme(plot.title = element_text(hjust = 0.5),
          axis.title.x = element_blank())
  
  # print plot
  p
}

```


```{r plot single marker}

# mapping arguments
map_arg <- list(
  "y" = c("SABGal_median", "EdU_median"),
  "ylab" = c("Sum Optical Density", "Sum Intensity (AU)"),
  title = c("SA-β-Gal", "EdU")
)


SABGal_EdU_plots <- df_single_marker$data %>%
  # generate plots
  map(.f = ~ pmap(
    map_arg,
    plot_single_marker,
    data = .x,
    test_results = SABGal_EdU_test_results
    )) %>%
  # name plots
  ## Serum
  set_names(df_single_marker$Serum) %>%
  ## SABGal or EdU
  map(~ set_names(.x, map_arg$y %>% str_remove_all(pattern = "_median"))
      ) %>%
  list_flatten()

# remove Serum faceting for FS and SS only plots
SABGal_EdU_plots[1:4] <- SABGal_EdU_plots[1:4] %>%
  map(~ .x + facet_grid())

SABGal_EdU_plots

```


### Panel SA-$\beta$-Gal & EdU data

```{r panel_SABGal_EdU_data, include=TRUE}

summary_all_datasets <- FS_only_summary_all_datasets +
  facet_grid() +
  # adjust legend
  ## labels Serum_Condition
  scale_fill_manual(values = RColorBrewer::brewer.pal(8, "Accent"),
                    labels = c(`FS CTL` = "CTL", `FS IR` = "IR"))

summary <- FS_only_summary +
  # adjust legend
  ## labels Serum_Condition
  scale_fill_manual(values = RColorBrewer::brewer.pal(8, "Accent"),
                    labels = c(`FS CTL` = "CTL", `FS IR` = "IR"))

all_datapoints <- FS_only +
  # adjust legend
  ## labels Serum_Condition
  scale_fill_manual(values = RColorBrewer::brewer.pal(8, "Accent"),
                    labels = c(`FS CTL` = "CTL", `FS IR` = "IR"))

panel_SABGal_EdU_data <- list(
  "summary_all_datasets" = summary_all_datasets,
  "summary" = summary,
  "all_datapoints" = all_datapoints
  )

panel_SABGal_EdU_data

```


# ICC & Morphology

```{r df ICC Morphology}

df_ICC_Morph <- ICC_Morph %>%
  # adjust col names
  rename_with(~ str_replace_all(., pattern = "-| ", replacement = "_")) %>%
  rename_with(~ str_replace_all(., pattern = "s/", replacement = "")) %>%
  rename(Condition = Legend, Cell.Type = Cell_line, Dataset = Batch) %>%
  # adjust Dataset/experiment # and serum values
  update_variable_values(variable = "Dataset",
                         old_values = 5:7,
                         new_values = 1:3) %>%
  mutate(
    Dataset = factor(Dataset),
    Serum = str_replace_all(Serum, pattern = "Serum starved", replacement = "Serum Starved"),
    Serum = str_replace_all(Serum, pattern = "Serum Starved", replacement = "SS"),
    Serum = str_replace_all(Serum, pattern = "Full Serum", replacement = "FS"),
    Condition = str_replace_all(Condition, pattern = "Mock", replacement = "CTL"),
    Condition = factor(Condition, levels = c("IR", "CTL")),
    Cell.Type = str_replace_all(Cell.Type, pattern = c("HMVECL" = "HMVEC-L",
                                                       "IMR90" = "IMR-90"))
  ) %>%
  # reorder cols
  select(Dataset, everything()) %>%
  # remove rows with NA values (entire Plate IF1 HMVECL Dataset 5 from 11/15/23 raw data)
  na.omit()

# add fold change setup
## create vector containing the variables we want to calculate the fold change for
all_var_names <- colnames(df_ICC_Morph)

var_interval_start <- grep(all_var_names, pattern = "NintAll_c1_overall_MEAN")
var_interval_end <- grep(all_var_names, pattern = "NintAll_c4_overall_MEAN")

variables <- c("Narea_overall", "NASP_overall", "NSF_overall",
               all_var_names[var_interval_start:var_interval_end],
               "average_speckle_count", "portion_of_cell_with_3+_speckle"
               )

## grouping arguments
grouping <- c("Dataset", "Plate", "Cell.Type", "Condition", "Serum", "Channel2", "Channel3")

df_ICC_Morph <- df_ICC_Morph %>%
  # add fold change
  add_fold_change(vars_to_normalize = variables,
                  grouping_arguments = grouping,
                  normalization_variable = "Condition",
                  normalization_value = "CTL") %>%
  # keep only yH2AX as 1st marker (because it'll be easier to plot it on its own axis)
  filter(Channel2 == "yH2AX")

df_ICC_summary <- df_ICC_Morph %>%
  # calculate mean and sd
  group_by(Dataset, Plate, Cell.Type, Condition, Serum, Channel2, Channel3) %>%
  summarise(
    across(c("Narea_overall", "NASP_overall", "NSF_overall", paste0(variables, "_fc")),
           list(mean = ~ mean(.x),
                sd = ~ sd(.x))
           )
  ) %>%
  ungroup()

df_ICC_summary_split <- df_ICC_summary %>%
  # split df based on Dataset
  split(.$Dataset)

df_ICC_summary_all_datasets <- df_ICC_Morph %>%
  # calculate mean and sd
  group_by(Cell.Type, Condition, Serum, Channel2, Channel3) %>%
  summarise(
    across(c("Narea_overall", "NASP_overall", "NSF_overall", paste0(variables, "_fc")),
           list(mean = ~ mean(.x),
                sd = ~ sd(.x))
           )
  ) %>%
  ungroup()

```

## ICC & Morphology images

```{r plot grid ICC_Morph, include=TRUE}

plot_grid_ICC_Morph <- function(data) {
  ggplot(data,
         aes(x = Condition,
             y = Channel3)) +
    geom_tile(color = "black",
              fill = "white") +
    geom_text(label = "image",
              size = 4) +
    facet_grid(. ~ Cell.Type) +
    labs(x = NULL,
         y = NULL) +
    theme_minimal()
}

grid_ICC_Morph <- plot_grid_ICC_Morph(df_ICC_summary %>%
                                        mutate(Condition = factor(Condition, levels = c("CTL","IR")))
                                        )

grid_ICC_Morph_FS <- plot_grid_ICC_Morph(
  df_ICC_summary %>%
    mutate(Condition = factor(Condition, levels = c("CTL","IR"))) %>%
    filter(Serum == "FS"))

grid_ICC_Morph_FS + labs(title = "FS only images")

```

## ICC data

### mean ± SD

```{r function plot 2D fold change}

plot_2D_fc_summary <- function(data,
                                x) {
  
  stopifnot(is.data.frame(data))
  stopifnot(is_character(x))
  
  # RColorBrewer::brewer.pal(9, "Set3") %>% rev()
  #"#D9D9D9" "#FCCDE5" "#B3DE69" "#FDB462" "#80B1D3" "#FB8072" "#BEBADA" "#FFFFB3" "#8DD3C7"
  palette_2D_fc <-  c("#FFFFB3", "#FDB462", "#80B1D3")
  palette_greys <- c(`3` = "#000000", `2` = "#737373", `1` = "#CCCCCC")
  
  pal_grey(0,1)(30)
  
  # plot
  ggplot(data %>%
           filter(Condition == "IR"), # keep only IR fc values
         aes(
          x = !!sym(x),
          y = NintAll_c3_overall_MEAN_fc_mean,
          fill = Channel3,
          shape = Cell.Type,
          )
         ) +
    geom_hline(yintercept = 1,
             linetype = "dotted",
             color = "black") +
    geom_vline(xintercept = 1,
             linetype = "dotted",
             color = "black") +
    geom_errorbar(aes(
      ymin = NintAll_c3_overall_MEAN_fc_mean - NintAll_c3_overall_MEAN_fc_sd,
      ymax = NintAll_c3_overall_MEAN_fc_mean + NintAll_c3_overall_MEAN_fc_sd
      )) +
    geom_errorbar(aes(
      xmin = !!sym(x) - !!sym(str_replace(x, pattern = "_mean", replacement = "_sd")),
      xmax = !!sym(x) + !!sym(str_replace(x, pattern = "_mean", replacement = "_sd"))
      )) +
    geom_point(
      aes(color = Dataset),
      size = 1.5,
      stroke = 1.2) +
    facet_grid(Serum ~ Cell.Type) +
    scale_fill_manual(values = palette_2D_fc) +
    scale_color_manual(values = palette_greys) +
    scale_shape_manual(values = c(22,24)) +
    labs(
      x = expression("Fold Change  " *gamma* "H2AX"),
      y = expression("Fold Change 2"^"nd"~"Marker")
    ) +
    guides(shape = guide_legend(order = 1, override.aes = list(stroke=0.5,size=2),
                                title = "Cell Type"),
           fill = guide_legend(order = 2,
                               title = "2"^"nd" ~ "Marker",
                               override.aes = list(shape=21,
                                                   size = 3,
                                                   stroke = 0.5)),
           color = guide_legend(order = 3,
                                override.aes = list(shape=21,
                                                    size=2))
           )
}

```

```{r plot 2D_fc_summary, include=TRUE}

`2D_fc_summary` <- plot_2D_fc_summary(df_ICC_summary, x = "average_speckle_count_fc_mean")

`2D_fc_summary` + labs(title = "FS and SS, mean ± SD, w/ dataset distinction")

```



```{r plot 2D_fc_summary FS only, include=TRUE}

`2D_fc_summary_FS` <- plot_2D_fc_summary(df_ICC_summary %>%
                                           filter(Serum == "FS"),
                                         x = "average_speckle_count_fc_mean")

`2D_fc_summary_FS` + labs(title = "only FS, mean ± SD, w/ dataset distinction")

```


```{r function 2D_fc_summary no dataset}

plot_2D_fc_summary_no_dataset_label <- function(data,
                                x) {
  
  stopifnot(is.data.frame(data))
  stopifnot(is_character(x))
  
  # RColorBrewer::brewer.pal(9, "Set3") %>% rev()
  #"#D9D9D9" "#FCCDE5" "#B3DE69" "#FDB462" "#80B1D3" "#FB8072" "#BEBADA" "#FFFFB3" "#8DD3C7"
  palette_2D_fc <-  c("#FFFFB3", "#FDB462", "#80B1D3")
  palette_greys <- c(`3` = "#000000", `2` = "#737373", `1` = "#CCCCCC")
  
  # plot
  ggplot(data %>%
           filter(Condition == "IR"), # keep only IR fc values
         aes(
          x = !!sym(x),
          y = NintAll_c3_overall_MEAN_fc_mean,
          fill = Channel3,
          shape = Cell.Type
          )
         ) +
    geom_hline(yintercept = 1,
             linetype = "dotted",
             color = "black") +
    geom_vline(xintercept = 1,
             linetype = "dotted",
             color = "black") +
    geom_errorbar(aes(
      ymin = NintAll_c3_overall_MEAN_fc_mean - NintAll_c3_overall_MEAN_fc_sd,
      ymax = NintAll_c3_overall_MEAN_fc_mean + NintAll_c3_overall_MEAN_fc_sd
      )) +
    geom_errorbar(aes(
      xmin = !!sym(x) - !!sym(str_replace(x, pattern = "_mean", replacement = "_sd")),
      xmax = !!sym(x) + !!sym(str_replace(x, pattern = "_mean", replacement = "_sd"))
      )) +
    geom_point(
      size = 1.5) +
    facet_grid(Serum ~ Cell.Type) +
    scale_fill_manual(values = palette_2D_fc) +
    scale_shape_manual(values = c(22,24)) +
    labs(
      x = expression("Fold Change  " *gamma* "H2AX"),
      y = expression("Fold Change 2"^"nd"~"Marker")
    ) +
    guides(shape = guide_legend(order = 1, override.aes = list(stroke=0.5,size=2),
                                title = "Cell Type"),
           fill = guide_legend(order = 2,
                               title = "2"^"nd" ~ "Marker",
                               override.aes = list(shape=21,
                                                   size = 3,
                                                   stroke = 0.5)),
           color = guide_legend(order = 3,
                                override.aes = list(shape=21,
                                                    size=2))
           )
}

```

```{r plot 2D_fc_summary no dataset, include=TRUE}

`2D_fc_summary_FS_no_dataset_label` <- plot_2D_fc_summary_no_dataset_label(df_ICC_summary %>%
                                                             filter(Serum == "FS"),
                                                           x = "average_speckle_count_fc_mean")

`2D_fc_summary_FS_no_dataset_label` +
  labs(title = "only FS, mean ± SD, w/ dataset distinction, w/o dataset label")

```

### mean ± SD - all datasets

```{r function 2D fold change all datasets}

plot_2D_fc_summary_all_datasets <- function(data,
                                x) {
  
  stopifnot(is.data.frame(data))
  stopifnot(is_character(x))
  
  # RColorBrewer::brewer.pal(9, "Set3") %>% rev()
  #"#D9D9D9" "#FCCDE5" "#B3DE69" "#FDB462" "#80B1D3" "#FB8072" "#BEBADA" "#FFFFB3" "#8DD3C7"
  palette_2D_fc <-  c("#FFFFB3", "#FDB462", "#80B1D3")
  palette_greys <- c(`3` = "#000000", `2` = "#737373", `1` = "#CCCCCC")
  
  # plot
  ggplot(data %>%
           filter(Condition == "IR"), # keep only IR fc values
         aes(
          x = !!sym(x),
          y = NintAll_c3_overall_MEAN_fc_mean,
          fill = Channel3,
          shape = Cell.Type
          )
         ) +
    geom_hline(yintercept = 1,
             linetype = "dotted",
             color = "black") +
    geom_vline(xintercept = 1,
             linetype = "dotted",
             color = "black") +
    geom_errorbar(aes(
      ymin = NintAll_c3_overall_MEAN_fc_mean - NintAll_c3_overall_MEAN_fc_sd,
      ymax = NintAll_c3_overall_MEAN_fc_mean + NintAll_c3_overall_MEAN_fc_sd
      )) +
    geom_errorbar(aes(
      xmin = !!sym(x) - !!sym(str_replace(x, pattern = "_mean", replacement = "_sd")),
      xmax = !!sym(x) + !!sym(str_replace(x, pattern = "_mean", replacement = "_sd"))
      )) +
    geom_point(
      size = 1.5) +
    facet_grid(Serum ~ Cell.Type) +
    scale_fill_manual(values = palette_2D_fc) +
    scale_shape_manual(values = c(22,24)) +
    labs(
      x = expression("Fold Change  " *gamma* "H2AX"),
      y = expression("Fold Change 2"^"nd"~"Marker")
    ) +
    guides(shape = guide_legend(order = 1, override.aes = list(stroke=0.5,size=2),
                                title = "Cell Type"),
           fill = guide_legend(order = 2,
                               title = "2"^"nd" ~ "Marker",
                               override.aes = list(shape=21,
                                                   size = 3,
                                                   stroke = 0.5)),
           color = guide_legend(order = 3,
                                override.aes = list(shape=21,
                                                    size=2))
           )
}

```

```{r plot 2D fold change all datasets}

`2D_fc_summary_all_datasets` <- plot_2D_fc_summary_all_datasets(
  df_ICC_summary_all_datasets,
  x = "average_speckle_count_fc_mean"
)

`2D_fc_summary_all_datasets`

```

```{r plot 2D fold change all datasets FS}

`2D_fc_summary_all_datasets_FS` <- plot_2D_fc_summary_all_datasets(
  df_ICC_summary_all_datasets %>%
    filter(Serum == "FS"),
  x = "average_speckle_count_fc_mean"
)

`2D_fc_summary_all_datasets_FS`

```

### all datapoints

```{r function 2D fold change all datapoints}

plot_2D_fc <- function(data,
                                x) {
  
  stopifnot(is.data.frame(data))
  stopifnot(is_character(x))
  
  # RColorBrewer::brewer.pal(9, "Set3") %>% rev()
  #"#D9D9D9" "#FCCDE5" "#B3DE69" "#FDB462" "#80B1D3" "#FB8072" "#BEBADA" "#FFFFB3" "#8DD3C7"
  palette_2D_fc <-  c("#FFFFB3", "#FDB462", "#80B1D3")
  palette_greys <- c(`3` = "#000000", `2` = "#737373", `1` = "#CCCCCC")
  
  # plot
  ggplot(data %>%
           filter(Condition == "IR"), # keep only IR fc values
         aes(
          x = !!sym(x),
          y = NintAll_c3_overall_MEAN_fc,
          fill = Channel3,
          shape = Cell.Type
          )
         ) +
    geom_hline(yintercept = 1,
             linetype = "dotted",
             color = "black") +
    geom_vline(xintercept = 1,
             linetype = "dotted",
             color = "black") +
    geom_point(
      aes(color = Dataset),
      size = 1.5, alpha=1/1.2,
      stroke = 1.2
      ) +
    facet_grid(Serum ~ Cell.Type) +
    scale_fill_manual(values = palette_2D_fc) +
    scale_color_manual(values = palette_greys) +
    scale_shape_manual(values = c(22,24)) +
    labs(
      x = expression("Fold Change  " *gamma* "H2AX"),
      y = expression("Fold Change 2"^"nd"~"Marker")
    ) +
    guides(shape = guide_legend(order = 1, override.aes = list(stroke=0.5,size=2),
                                title = "Cell Type"),
           fill = guide_legend(order = 2,
                               title = "2"^"nd" ~ "Marker",
                               override.aes = list(shape=21,
                                                   size = 3,
                                                   stroke = 0.5)),
           color = guide_legend(order = 3,
                                override.aes = list(shape=21,
                                                    size=2))
           )
}

```

```{r plot 2D fold change all datapoints FS}


`2D_fc_FS` <- plot_2D_fc(df_ICC_Morph %>%
                                          filter(Serum == "FS"),
                                        x = "average_speckle_count_fc")

`2D_fc_FS` + labs(title = "All datapoints, w/ dataset distinction")


```


```{r function 2D fold change all datapoints no datasets}

plot_2D_fc_no_datasets <- function(data,
                                x) {
  
  stopifnot(is.data.frame(data))
  stopifnot(is_character(x))
  
  # RColorBrewer::brewer.pal(9, "Set3") %>% rev()
  #"#D9D9D9" "#FCCDE5" "#B3DE69" "#FDB462" "#80B1D3" "#FB8072" "#BEBADA" "#FFFFB3" "#8DD3C7"
  palette_2D_fc <-  c("#FFFFB3", "#FDB462", "#80B1D3")
  palette_greys <- c(`3` = "#000000", `2` = "#737373", `1` = "#CCCCCC")
  
  # plot
  ggplot(data %>%
           filter(Condition == "IR"), # keep only IR fc values
         aes(
          x = !!sym(x),
          y = NintAll_c3_overall_MEAN_fc,
          fill = Channel3,
          shape = Cell.Type
          )
         ) +
    geom_hline(yintercept = 1,
             linetype = "dotted",
             color = "black") +
    geom_vline(xintercept = 1,
             linetype = "dotted",
             color = "black") +
    geom_point(
      size = 1.5) +
    facet_grid(Serum ~ Cell.Type) +
    scale_fill_manual(values = palette_2D_fc) +
    scale_shape_manual(values = c(22,24)) +
    labs(
      x = expression("Fold Change  " *gamma* "H2AX"),
      y = expression("Fold Change 2"^"nd"~"Marker")
    ) +
    guides(shape = guide_legend(order = 1, override.aes = list(stroke=0.5,size=2),
                                title = "Cell Type"),
           fill = guide_legend(order = 2,
                               title = "2"^"nd" ~ "Marker",
                               override.aes = list(shape=21,
                                                   size = 3,
                                                   stroke = 0.5))
           )
}

```

```{r plot 2D fold change all datapoints no datasets}


`2D_fc_no_datasets` <- plot_2D_fc_no_datasets(df_ICC_Morph %>%
                                          filter(Serum == "FS"),
                                        x = "average_speckle_count_fc")

`2D_fc_no_datasets`


```

#### Single marker plots

```{r df single marker ICC}

# generate df with both FS and SS
FS_SS <- df_ICC_Morph %>%
  # remove dataset 1, because it didn't have enough cells
  filter(Dataset != "1") %>%
  # turn categorical vars into factors
  mutate(
    Condition = factor(Condition, levels = c("CTL","IR")),
    Serum = factor(Serum, levels = c("FS", "SS")),
    Cell.Type = factor(Cell.Type, levels = c("HMVEC-L", "IMR-90")),
    Channel3 = factor(Channel3)
  )

# split df based on Serum
df_ICC_Morph_Serum <- FS_SS %>%
  group_by(Serum) %>%
  nest() %>%
  # re-add Serum as variable in split df
  # Serum will be needed for faceting within the plot function
  mutate(
    data = map(data, ~ bind_cols(Serum = first(Serum), .x))
  ) %>%
  ungroup()

# add FS_SS df
df_ICC_Morph_Serum <- df_ICC_Morph_Serum %>%
  bind_rows(
    tibble(
      Serum = "FS_SS",
      data = list(FS_SS)
    )
  )

# split df based on Serum and the 2nd marker (Channel3)
df_ICC_Morph_Serum_2ndMarker <- FS_SS %>%
  group_by(Serum, Channel3) %>%
  nest() %>%
  # re-add Serum and Channel3 as variable in split df
  # they will be needed for the plotting function
  mutate(
    data = map(data, ~ bind_cols(Serum = Serum, .x)),
    data = map(data, ~ bind_cols(Channel3 = Channel3, .x))
  ) %>%
  ungroup()

# add FS_SS df
df_FS_SS <- FS_SS %>%
  group_by(Channel3) %>%
  nest() %>%
  mutate(
    Serum = "FS_SS",
    # re-add Serum and Channel3 as variable in split df
    # they will be needed for the plotting function
    data = map(data, ~ bind_cols(Channel3 = Channel3, .x))
    )

df_ICC_Morph_Serum_2ndMarker <- df_ICC_Morph_Serum_2ndMarker %>%
  bind_rows(df_FS_SS)

```

```{r stats single marker ICC}

original_df <- df_ICC_Morph_Serum %>%
  # select df with both FS and SS
  filter(Serum == "FS_SS") %>%
  .$data %>%
  .[[1]]

# Compare IR vs CTL samples for yH2AX
ICC_Morph_Serum_test_results <- original_df %>%
  # calculate adj-pvalues
  calculate_test_results(
  variables = c("average_speckle_count"),
  grouping = c("Serum", "Cell.Type")
  ) %>%
  # calculate x:y coordinates for stat annotations
  calculate_annotation_position(
    test_results_df = .,
    original_df = original_df,
    grouping = c("Serum", "Cell.Type")
  )

ICC_Morph_Serum_test_results

original_df <- df_ICC_Morph_Serum_2ndMarker %>%
  # select df with both FS and SS
  filter(Serum == "FS_SS") %>%
  # flatten df
  select(data) %>%
  unnest(data)

# Compare IR vs CTL samples for 2nd markers
ICC_Morph_Serum_2ndMarker_test_results <- original_df %>%
  # calculate adj-pvalues
  calculate_test_results(
    variables = c("NintAll_c3_overall_MEAN"),
    grouping = c("Serum", "Cell.Type", "Channel3")
  ) %>%
  # calculate x:y coordinates for stat annotations
  calculate_annotation_position(
    test_results_df = .,
    original_df = original_df,
    grouping = c("Serum", "Cell.Type", "Channel3")
  )

ICC_Morph_Serum_2ndMarker_test_results

```


```{r plot single marker ICC}

# generate yH2AX plots for each Serum condition
ICC_yH2AX <- map(
  df_ICC_Morph_Serum$data,
  plot_single_marker,
  y = "average_speckle_count", ylab = "Average Foci", title = "γH2AX",
  test_results = ICC_Morph_Serum_test_results
  ) %>%
  set_names(paste0(df_ICC_Morph_Serum$Serum, "_yH2AX"))

# remove faceting for FS and SS only plots
ICC_yH2AX[1:2] <- ICC_yH2AX[1:2] %>%
  map(~ .x + facet_grid())

# print 
ICC_yH2AX

# generate 2nd Markers plots for each Serum condition

## map arg
map_arg <- df_ICC_Morph_Serum_2ndMarker %>%
  mutate(
    # generate ylab labels
    ylab = "Mean Intensity (AU)",
    title = Channel3
  ) %>%
  # keep only cols to be used as fun arguments
  select(data, ylab, title)

## plot
ICC_2ndMarkers <- pmap(
  map_arg,
  plot_single_marker,
  y = "NintAll_c3_overall_MEAN",
  test_results = ICC_Morph_Serum_2ndMarker_test_results
) %>%
  set_names(paste(df_ICC_Morph_Serum_2ndMarker$Serum,
                  df_ICC_Morph_Serum_2ndMarker$Channel3,
                  sep = "_"))

# remove faceting for FS and SS only plots
ICC_2ndMarkers[1:6] <- ICC_2ndMarkers[1:6] %>%
  map(~ .x + facet_grid())

ICC_2ndMarkers
```


### Panel ICC data

```{r Panel ICC data}

all_datapoints_all_datasets <- `2D_fc_summary_all_datasets_FS` +
  # remove FS facet label
  facet_grid(. ~ Cell.Type)

all_datapoints_all_datasets_nofacets <- all_datapoints_all_datasets +
  # remove Cell.Type faceting
  facet_grid()

summary_all_datasets <- `2D_fc_summary_FS_no_dataset_label` +
  # remove FS facet label
  facet_grid(. ~ Cell.Type)

summary_all_datasets_nofacets <- summary_all_datasets +
  # remove Cell.Type faceting
  facet_grid()

summary <- `2D_fc_summary_FS` +
  # remove FS facet label
  facet_grid(. ~ Cell.Type)

summary_nofacets <- summary +
  # remove Cell.Type faceting
  facet_grid()

all_datapoints <- `2D_fc_FS` +
  # remove FS facet label
  facet_grid(. ~ Cell.Type)

all_datapoints_nofacets <- all_datapoints +
  # remove Cell.Type faceting
  facet_grid()


panel_ICC_data <- list(
  "all_datapoints_all_datasets" = all_datapoints_all_datasets,
  "all_datapoints_all_datasets_nofacets" = all_datapoints_all_datasets_nofacets,
  "summary_all_datasets" = summary_all_datasets,
  "summary_all_datasets_nofacets" = summary_all_datasets_nofacets,
  "summary" = summary,
  "summary_nofacets" = summary_nofacets,
  "all_datapoints" = all_datapoints,
  "all_datapoints_nofacets" = all_datapoints_nofacets
)

```


## Morphology data

```{r df Morph}

df_Morph <- df_ICC_Morph %>%
  select(which(!stringr::str_detect(names(.), "Nint|speckle"))) %>%
  mutate(
    # create fct column that combines condition_serum to assign colors
    Serum_Condition = paste0(Serum, " ", Condition),
    Serum_Condition = factor(Serum_Condition),
    Condition = factor(Condition, levels = c("CTL", "IR"))
  ) %>%
  select(Dataset, Plate, Cell.Type, Serum, Condition, Serum_Condition, everything())

df_Morph_summary <- df_Morph %>%
  # calculate mean and sd
  group_by(Dataset, Plate, Cell.Type, Condition, Serum, Channel2) %>%
  summarise(
    across(c("Narea_overall", "NASP_overall", "NSF_overall"),
           list(mean = ~ mean(.x),
                sd = ~ sd(.x))
           )
  ) %>%
  ungroup()

df_Morph_summary_alldatasets <- df_Morph %>%
  # calculate mean and sd
  group_by(Cell.Type, Condition, Serum, Channel2) %>%
  summarise(
    across(c("Narea_overall", "NASP_overall", "NSF_overall"),
           list(mean = ~ mean(.x),
                sd = ~ sd(.x))
           )
  ) %>%
  ungroup()

df_Morph_summary_split <- df_Morph %>%
  # split df based on Dataset
  split(.$Dataset)

list_df_Morph <- list(
  "alldp" = df_Morph,
  "summary" = df_Morph_summary,
  "summary_allds" = df_Morph_summary_alldatasets
)

```

### FS only

```{r df Morph FS}

list_df_Morph_FS <- map(
  list_df_Morph,
  ~ filter(.x, Serum == "FS")
)

```


```{r function plot Morph}

plot_Morph <- function(data, y, ylab) {
  
  palette <- RColorBrewer::brewer.pal(9, "Set1") %>% .[c(3:4)]
  palette_greys <- c(`3` = "#000000", `2` = "#737373", `1` = "#CCCCCC")
  
  ggplot(data,
         aes(y = !!sym(y),
             x = Condition)
         ) +
    geom_jitter(height=0, size=2, stroke=1.2, alpha=1/1.2,
               aes(
                 shape = Cell.Type,
                 fill = Condition,
                 color = Dataset)
               ) +
    facet_grid(. ~ Cell.Type) +
    labs(y = ylab) +
    scale_shape_manual(values = c(22,24)) +
    scale_fill_manual(values = palette) +
    scale_color_manual(values = palette_greys) +
    guides(shape = guide_legend(order=1,
                                override.aes = list(stroke=0.5, size=2)),
           fill = guide_legend(order=2,
                                override.aes = list(shape=21, stroke=0.5, size=3)),
           color = guide_legend(order=3,
                                override.aes = list(shape=21, size=2))
           )
}

```

```{r function plot Morph summary}

plot_Morph_summary <- function(data, y, ylab) {
  
  
  palette <- RColorBrewer::brewer.pal(9, "Set1") %>% .[c(3:4)]
  palette_greys <- c(`3` = "#000000", `2` = "#737373", `1` = "#CCCCCC")
  
  ggplot(data,
         aes(y = !!sym(y),
             x = Condition)
         ) +
    geom_errorbar(
      width=0.2, position=position_dodge(width = 0.5),
      aes(ymin = !!sym(y) - !!sym(str_replace_all(y, pattern="_mean", replacement="_sd")),
          ymax = !!sym(y) + !!sym(str_replace_all(y, pattern="_mean", replacement="_sd")),
          color = Dataset
      )) +
    geom_point(size=2, stroke=1.2, position=position_dodge(width = 0.5),
               aes(
                 shape = Cell.Type,
                 fill = Condition,
                 color = Dataset)
               ) +
    facet_grid(. ~ Cell.Type) +
    labs(y = ylab) +
    scale_shape_manual(values = c(22,24)) +
    scale_fill_manual(values = palette) +
    scale_color_manual(values = palette_greys) +
    guides(shape = guide_legend(order=1,
                                override.aes = list(stroke=0.5, size=2)),
           fill = guide_legend(order=2,
                                override.aes = list(shape=21, stroke=0.5, size=3)),
           color = guide_legend(order=3,
                                override.aes = list(shape=21, size=2))
           )
}

```

```{r function plot Morph summary all datasets}

plot_Morph_summary_allds <- function(data, y, ylab) {
  
  
  palette <- RColorBrewer::brewer.pal(9, "Set1") %>% .[c(3:4)]
  palette_greys <- c(`3` = "#000000", `2` = "#737373", `1` = "#CCCCCC")
  
  ggplot(data,
         aes(y = !!sym(y),
             x = Condition,
             shape = Cell.Type)
         ) +
    geom_errorbar(
      width=0.2, position=position_dodge(width = 0.5),
      aes(ymin = !!sym(y) - !!sym(str_replace_all(y, pattern="_mean", replacement="_sd")),
          ymax = !!sym(y) + !!sym(str_replace_all(y, pattern="_mean", replacement="_sd"))
      )) +
    geom_point(size=2, stroke=1.2, position=position_dodge(width = 0.5),
               aes(
                 shape = Cell.Type,
                 fill = Condition)
               ) +
    labs(y = ylab) +
    scale_shape_manual(values = c(22,24)) +
    scale_fill_manual(values = palette) +
    scale_color_manual(values = palette_greys) +
    guides(shape = guide_legend(order=1,
                                override.aes = list(stroke=0.5, size=2)),
           fill = guide_legend(order=2,
                                override.aes = list(shape=21, stroke=0.5, size=3)),
           color = guide_legend(order=3,
                                override.aes = list(shape=21, size=2))
           )
}

```

```{r plot Morph alldp}

# create mapping arguments
map_arg <- list(y = c("Narea_overall", "NASP_overall", "NSF_overall"),
                ylab = c("Nuclear Area (px^2)", "Nuclear Aspect Ratio", "Nuclear Shape Factor")
                )
# generate plots
Morph_alldp <- pmap(map_arg, plot_Morph, data = list_df_Morph_FS$alldp) %>%
  # name plots
  set_names(c("Area", "ASP", "SF"))

Morph_alldp

```

```{r plot Morph summary}

# create mapping arguments
map_arg_summary <- map_arg
map_arg_summary$y <- paste0(map_arg_summary$y, "_mean")

# generate plots
Morph_summary <- pmap(map_arg_summary, plot_Morph_summary, data = list_df_Morph_FS$summary) %>%
  set_names(c("Area", "ASP", "SF"))

Morph_summary

```

```{r plot Morph summary allds}

# generate plots
Morph_summary_allds <- pmap(map_arg_summary,
                            plot_Morph_summary_allds,
                            data = list_df_Morph_FS$summary_allds)

# name plots
names(Morph_summary_allds) <- c("Area", "ASP", "SF")

Morph_summary_allds

```

#### Single marker

```{r df single marker morph}

FS_SS <- list_df_Morph$alldp %>%
  # remove dataset 1 because of low cell counts
  filter(Dataset != 1) %>%
  mutate(
    # turn categorical vars into factors
    Condition = factor(Condition),
    Serum = factor(Serum),
    Cell.Type = factor(Cell.Type),
    # change Area unit from px^2 to µm^2 (1 px = 0.65 µm)
    Narea_overall = Narea_overall * 0.65^2
  )

df_single_marker_Morph <- FS_SS %>%
  group_by(Serum) %>%
  nest() %>%
  # re-add Serum variable
  # for faceting in plottting function
  mutate(
    data = map(data, ~ bind_cols(Serum = Serum, .x))
  ) %>%
  ungroup()

# re-add df with both FS and SS
df_FS_SS <- tibble(
  Serum = "FS_SS",
  data = list(FS_SS)
)

df_single_marker_Morph <- df_single_marker_Morph %>%
  bind_rows(df_FS_SS)

df_single_marker_Morph

```

```{r stats single marker morph}

original_df <- df_single_marker_Morph %>%
  # select df with both FS and SS
  filter(Serum == "FS_SS") %>%
  .$data %>%
  .[[1]]

# Compare IR vs CTL samples for yH2AX
single_marker_Morph_test_results <- original_df %>%
  # calculate adj-pvalues
  calculate_test_results(
  variables = c("Narea_overall", "NASP_overall", "NSF_overall"),
  grouping = c("Serum", "Cell.Type")
  ) %>%
  # calculate x:y coordinates for stat annotations
  calculate_annotation_position(
    test_results_df = .,
    original_df = original_df,
    grouping = c("Serum", "Cell.Type")
  )

single_marker_Morph_test_results

```


```{r plot single marker morph}

# mapping arguments
map_arg <- list(
  y = c("Narea_overall","NASP_overall","NSF_overall"),
  ylab = c("Nuclear Area (px^2)", "Nuclear Aspect Ratio", "Nuclear Shape Factor"),
  title = c("Area","Aspect Ratio","Shape Factor")
)

# generate plots
Morph_plots <- df_single_marker_Morph$data %>%
  # plots
  map(.f = ~ pmap(
    map_arg,
    plot_single_marker,
    data = .x,
    test_results = single_marker_Morph_test_results
  )) %>%
  # name plots
  ## Serum
  set_names(df_single_marker_Morph$Serum) %>%
  ## nuclear morphology feature
  map(.f = ~ set_names(.x, c("Area","ASP","SF"))) %>%
  list_flatten()

# remove faceting in FS and SS only plots
Morph_plots[1:6] <- Morph_plots[1:6] %>%
  map(~ .x + facet_grid())

# print
Morph_plots

```


# Fig 1

```{r Fig 1 data panels: SABGal_EdU ICC, fig.asp=1.33, eval=FALSE}

layout1 <- "
AD
BE
CF
GG
GG
"
layout2 <- "
AD
BE
CF
GG
GG
"
theme_Fig1 <- theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 8),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8),
        legend.key.size = unit(0.35, "cm"),
        legend.spacing.y = unit(0.1, "cm"),
        legend.spacing.x = unit(0.1, "cm"),
        strip.text = element_text(size = 8)
        )

Figure1_data_panels <-
  panel_SABGal_EdU_data$summary_all_datasets + labs(title = "SABGal & EdU plots") +
  panel_SABGal_EdU_data$summary +
  panel_SABGal_EdU_data$all_datapoints +
  panel_ICC_data$all_datapoints_all_datasets_nofacets + labs(title = "ICC plots") +
  panel_ICC_data$summary +
  panel_ICC_data$all_datapoints +
  ggplot() + theme_void() +
  plot_layout(design = layout1) &
  theme_Fig1

Figure1_data_panels

```

```{r Worfklow, eval=FALSE}

Fig1_workflow <- magick::image_read("Fig1_workflow.png")
print(Fig1_workflow)

# this create img with very poor quality
Workflow <- ggplot() + 
  annotation_custom(grob = grid::rasterGrob(
    Fig1_workflow,
    width = unit(7.2, "in"),
    height = unit(1.5, "in")
    ),
    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  theme_void()

# this doesn't work
Workflow <- ggplot() +
  annotation_custom(
    magick::image_raster(Fig1_workflow), 
    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf
  ) +
  theme_void()

# Workflow

```


```{r Fig1, include=TRUE, fig.asp=1.33, eval=FALSE}

layout <- "
AAAAAAAAAAAA
BBBBBBBCCCCC
DDDDDDDEEEEE
DDDDDDDEEEEE
FFFFFFFFFFFF
"
layout_summary_allds <- "
AAAAAAAAAAAA
BBBBBBBBCCCC
DDDDDDDDEEEE
DDDDDDDDEEEE
FFFFFFFFFFFF
"
theme_morph <- theme(axis.title.x = element_blank())
theme_Fig1 <- theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 8),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 8),
        legend.key.size = unit(0.35, "cm"),
        legend.spacing.y = unit(0.1, "cm"),
        legend.spacing.x = unit(0.1, "cm"),
        strip.text = element_text(size = 8)
        )

# all datapoints

Figure1_summary_allds <- ggplot()+theme_void() +
  grid_SABGal_EdU_FS +
  panel_SABGal_EdU_data$summary_all_datasets +
  grid_ICC_Morph_FS +
  panel_ICC_data$all_datapoints_all_datasets_nofacets +
  (Morph_summary_allds$Area + theme_morph +
     Morph_summary_allds$ASP + theme_morph +
     Morph_summary_allds$SF + theme_morph +
     plot_layout(guides = "collect")) +
  plot_layout(design = layout_summary_allds) +
  plot_annotation(tag_levels = "a") &
  theme_Fig1

# summary with split based on dataset

Figure1_summary <- ggplot()+theme_void() +
  grid_SABGal_EdU_FS +
  panel_SABGal_EdU_data$summary +
  grid_ICC_Morph_FS +
  panel_ICC_data$summary +
  (Morph_summary$Area + theme_morph +
     Morph_summary$ASP + theme_morph +
     Morph_summary$SF + theme_morph +
     plot_layout(guides = "collect")
    ) +
  plot_layout(design = layout) +
  plot_annotation(tag_levels = "a") &
  theme_Fig1

# summary

Figure1_alldp <- ggplot()+theme_void() +
  grid_SABGal_EdU_FS +
  panel_SABGal_EdU_data$all_datapoints +
  grid_ICC_Morph_FS +
  panel_ICC_data$all_datapoints +
  (Morph_alldp$Area + theme_morph +
     Morph_alldp$ASP + theme_morph +
     Morph_alldp$SF + theme_morph +
     plot_layout(guides = "collect")
    ) +
  plot_layout(design = layout) +
  plot_annotation(tag_levels = "a") &
  theme_Fig1

# Figure1_1marker

layout_1marker <- "
AAAAAAAAAAAA
BBBBBBCCCCCC
DDDDDDEEEEEE
DDDDDDEEEEEE
FFFFFFFFFFFF
"
theme_Fig1_1marker <- theme(
  plot.title = element_text(size = 10),
  axis.title = element_text(size = 9),
  axis.text = element_text(size = 7.5),
  legend.title = element_blank(),
  legend.text = element_text(size = 8),
  legend.key.size = unit(0.35, "cm"),
  legend.spacing.y = unit(0.3, "cm"),
  legend.spacing.x = unit(0.1, "cm"),
  strip.text = element_text(size = 8)
  )

Figure1_1marker <- ggplot()+theme_void() +
  free(grid_SABGal_EdU_FS) +
  ((SABGal_EdU_plots$FS_SABGal + SABGal_EdU_plots$FS_EdU + plot_layout(guides = "collect"))) +
  free(grid_ICC_Morph_FS) +
  (
    (ICC_yH2AX$FS_yH2AX | ICC_2ndMarkers$FS_p21) /
      (ICC_2ndMarkers$FS_LaminB1 | ICC_2ndMarkers$FS_HMGB1) +
      plot_layout(guides = "collect")
  ) +
  (
    Morph_plots$FS_Area + theme_morph +
      Morph_plots$FS_ASP + theme_morph +
      Morph_plots$FS_SF + theme_morph +
      plot_layout(guides = "collect")
  ) +
  plot_layout(design = layout_1marker) +
  plot_annotation(tag_levels = "a") &
  theme_Fig1_1marker

Figure1_1marker

# Figure1_v2
layout_Figure1_v2 <-"
AAAAAAAAAAAA
BBBCCCCCCCCC
DDEEEEEEEFFF
DDEEEEEEEFFF
DDEEEEEEEFFF
"

theme_Figure1_v2 <- theme(
  plot.title = element_text(size = 10),
  axis.title = element_text(size = 9),
  axis.text = element_text(size = 7.5),
  axis.text.x = element_text(size = 7.5, angle = 30, hjust = 1),
  legend.title = element_blank(),
  legend.text = element_text(size = 8),
  legend.key.size = unit(0.35, "cm"),
  legend.spacing.y = unit(0.3, "cm"),
  legend.spacing.x = unit(0.1, "cm"),
  legend.position = "top",
  strip.text = element_text(size = 8)
  )

Figure1_v2 <- ggplot()+theme_void() + 
  free(grid_SABGal_EdU_FS) + free(grid_ICC_Morph_FS) +
  ((SABGal_EdU_plots$FS_SABGal / SABGal_EdU_plots$FS_EdU)) +
  (
    (ICC_yH2AX$FS_yH2AX | ICC_2ndMarkers$FS_p21) /
      (ICC_2ndMarkers$FS_LaminB1 | ICC_2ndMarkers$FS_HMGB1)
  ) +
  (
    Morph_plots$FS_Area / Morph_plots$FS_ASP / Morph_plots$FS_SF
  ) + theme(axis.title.x = element_blank()) +
  plot_layout(design = layout_Figure1_v2,
              guides = "collect") +
  plot_annotation(tag_levels = "a") &
  theme_Figure1_v2

# adjust x axis text for grids
Figure1_v2[[2]] <- Figure1_v2[[2]] + theme(axis.text.x = element_text(size = 7.5,
                                                                      angle = 0,
                                                                      hjust = 0.5))
Figure1_v2[[3]] <- Figure1_v2[[3]] + theme(axis.text.x = element_text(size = 7.5,
                                                                      angle = 0,
                                                                      hjust = 0.5))
Figure1_v2

Figure1_v2_SS <- ggplot()+theme_void() + 
  free(grid_SABGal_EdU_FS) + free(grid_ICC_Morph_FS) +
  ((SABGal_EdU_plots$SS_SABGal / SABGal_EdU_plots$SS_EdU)) +
  (
    (ICC_yH2AX$SS_yH2AX | ICC_2ndMarkers$SS_p21) /
      (ICC_2ndMarkers$SS_LaminB1 | ICC_2ndMarkers$SS_HMGB1)
  ) +
  (
    Morph_plots$SS_Area / Morph_plots$SS_ASP / Morph_plots$SS_SF
  ) + theme(axis.title.x = element_blank()) +
  plot_layout(design = layout_Figure1_v2,
              guides = "collect") +
  plot_annotation(tag_levels = "a") &
  theme_Figure1_v2

# adjust x axis text for grids
Figure1_v2_SS[[2]] <- Figure1_v2_SS[[2]] + theme(axis.text.x = element_text(size = 7.5,
                                                                      angle = 0,
                                                                      hjust = 0.5))
Figure1_v2_SS[[3]] <- Figure1_v2_SS[[3]] + theme(axis.text.x = element_text(size = 7.5,
                                                                      angle = 0,
                                                                      hjust = 0.5))
Figure1_v2_SS


Figure1 <- list(
  "Figure1_summary_allds" = Figure1_summary_allds,
  "Figure1_summary" = Figure1_summary,
  "Figure1_alldp" = Figure1_alldp
)

# Figure1

```

```{r Fig Population Data, include=TRUE, fig.asp=1.33}

Panel_Representative_Images <- ggplot() + theme_void()

# # Patchwork v1
# ## SABGal & EdU
# Panel_SABGal_EdU <- SABGal_EdU_plots$FS_SABGal / SABGal_EdU_plots$FS_EdU
# 
# ## ICC
# Panel_ICC <- ICC_yH2AX$FS_yH2AX + ICC_2ndMarkers$FS_p21 +
#   ICC_2ndMarkers$FS_LaminB1 + ICC_2ndMarkers$FS_HMGB1 +
#   plot_layout(nrow = 2)
# 
# ## Morph
# Panel_Morphology <- Morph_plots$FS_Area / Morph_plots$FS_ASP
# 
# layout1 <- "
# AAAA
# BCCD
# BCCD
# "
# Fig_PopData_v6.1 <- Panel_Representative_Images +
#       (Panel_SABGal_EdU + plot_layout(tag_level = 'new')) +
#       (Panel_ICC + plot_layout(tag_level = "new")) +
#       (Panel_Morphology + plot_layout(tag_level = "new")) +
#   plot_layout(design = layout1,
#               guides = "collect") +
#   plot_annotation(tag_level = list("a", c(""))) &
#   theme(legend.position = "top")
# 
# ## remove extra tags
# ### SABGal EdU
# Fig_PopData_v6.1[[2]][[2]] <- Fig_PopData_v6.1[[2]][[2]] + theme(plot.tag = element_blank())
# ### ICC
# Fig_PopData_v6.1[[3]][[2]] <- Fig_PopData_v6.1[[3]][[2]] + theme(plot.tag = element_blank())
# Fig_PopData_v6.1[[3]][[3]] <- Fig_PopData_v6.1[[3]][[3]] + theme(plot.tag = element_blank())
# Fig_PopData_v6.1[[3]][[4]] <- Fig_PopData_v6.1[[3]][[4]] + theme(plot.tag = element_blank())
# ### Morphology
# Fig_PopData_v6.1[[4]][[2]] <- Fig_PopData_v6.1[[4]][[2]] + theme(plot.tag = element_blank())
# 
# Fig_PopData_v6.1

# # Patchwork v2
# layout2 <- "
# AAAA
# BCDE
# BCDE
# FGHI
# FGHI
# "
# Fig_PopData_v6.2 <- Panel_Representative_Images +
#   SABGal_EdU_plots$FS_SABGal + ICC_yH2AX$FS_yH2AX + ICC_2ndMarkers$FS_p21 + Morph_plots$FS_Area +
#   SABGal_EdU_plots$FS_EdU + ICC_2ndMarkers$FS_LaminB1 + ICC_2ndMarkers$FS_HMGB1 + Morph_plots$FS_SF +
#   plot_layout(design = layout2,
#               guides = "collect") +
#   plot_annotation(tag_levels = list(c("a", "b", "c", "", "d", "", "", "", "", ""))) &
#   theme(plot.title = element_text(size = 10),
#         plot.tag = element_text(size = 16, face = "bold"),
#         legend.position = "top",
#         legend.key.size = unit(0.5, "cm"),
#         axis.title = element_text(size = 10),
#         axis.text = element_text(size = 8),
#         )
# 
# Fig_PopData_v6.2

# # Patchwork v3
# layout2 <- "
# AAAA
# BCDE
# BCDE
# FGHI
# FGHI
# "
# Fig_PopData_v6.3 <- Panel_Representative_Images +
#   SABGal_EdU_plots$FS_SS_SABGal + ICC_yH2AX$FS_SS_yH2AX + ICC_2ndMarkers$FS_SS_p21 + Morph_plots$FS_SS_Area +
#   SABGal_EdU_plots$FS_SS_EdU + ICC_2ndMarkers$FS_SS_LaminB1 + ICC_2ndMarkers$FS_SS_HMGB1 + Morph_plots$FS_SS_SF + coord_cartesian(ylim = c(0.6,1.2)) +
#   plot_layout(design = layout2,
#               guides = "collect") +
#   plot_annotation(tag_levels = list(c("a", "b", "c", "", "d", "", "", "", "", ""))) &
#   theme(plot.title = element_text(size = 10),
#         plot.tag = element_text(size = 16, face = "bold"),
#         legend.position = "top",
#         legend.key.size = unit(0.5, "cm"),
#         axis.title = element_text(size = 10),
#         axis.text = element_text(size = 8),
#         axis.text.x = element_text(size = 8, angle = 30, hjust = 1),
#         strip.text = element_text(size = 10)
#         )
# 
# Fig_PopData_v6.3

# # Patchwork v4
# layout4 <- "
# AA
# AA
# AA
# BC
# BC
# DE
# DE
# FG
# FG
# HI
# HI
# "
# 
# Fig_PopData_v6.4 <- Panel_Representative_Images +
#   SABGal_EdU_plots$FS_SS_SABGal + SABGal_EdU_plots$FS_SS_EdU +
#   ICC_yH2AX$FS_SS_yH2AX + ICC_2ndMarkers$FS_SS_p21 +
#   ICC_2ndMarkers$FS_SS_LaminB1 + ICC_2ndMarkers$FS_SS_HMGB1 +
#   Morph_plots$FS_SS_Area + Morph_plots$FS_SS_SF + coord_cartesian(ylim = c(0.6,1.2)) +
#   plot_layout(design = layout4,
#               guides = "collect") +
#   plot_annotation(tag_levels = list(c("a", "b", "", "c", "", "", "", "d", ""))) &
#   theme(plot.title = element_text(size = 10),
#         plot.tag = element_text(size = 12, face = "bold"),
#         legend.position = "top",
#         legend.key.size = unit(0.5, "cm"),
#         axis.title = element_text(size = 10),
#         axis.text = element_text(size = 8),
#         axis.text.x = element_text(size = 8),
#         strip.text = element_text(size = 8),
#         strip.background = element_rect(fill = "white")
#         )
# 
# Fig_PopData_v6.4

# Patchwork v4
layout5 <- "
AA
AA
AA
BC
BC
DE
DE
FG
FG
HI
HI
"

Fig_PopData_v6.7 <- Panel_Representative_Images +
  SABGal_EdU_plots$FS_SS_SABGal + SABGal_EdU_plots$FS_SS_EdU +
  ICC_yH2AX$FS_SS_yH2AX + ICC_2ndMarkers$FS_SS_p21 +
  ICC_2ndMarkers$FS_SS_LaminB1 + ICC_2ndMarkers$FS_SS_HMGB1 +
  Morph_plots$FS_SS_Area + Morph_plots$FS_SS_SF + coord_cartesian(ylim = c(0.6,1.2)) +
  plot_layout(design = layout5,
              guides = "keep") +
  plot_annotation(tag_levels = list(c("a", "b", "", "c", "", "#", "#", "d", ""))) &
  theme(plot.title = element_text(size = 10, hjust = 0.5),
        plot.tag = element_text(size = 12, face = "bold", vjust = 2),
        plot.margin = margin(t = 0.5, unit = "cm"),
        legend.position = "right",
        legend.margin = margin(l = -0.25, r = 0.1, unit = "cm"),
        legend.key.size = unit(0.3, "cm"),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 8),
        strip.text = element_text(size = 8),
        strip.background = element_rect(fill = "white")
        )

# remove top margin in panel a

Fig_PopData_v6.7[[1]] <- Fig_PopData_v6.7[[1]] +
  theme(plot.margin = margin())

# remove empty empty space between 1st and 2nd row of ICC panel

Fig_PopData_v6.7[[6]] <- Fig_PopData_v6.7[[6]] +
  theme(plot.tag = element_blank(),
        plot.margin = margin(t = 0.2, unit = "cm")
        )

Fig_PopData_v6.7[[7]] <- Fig_PopData_v6.7[[7]] +
  theme(plot.tag = element_blank(),
        plot.margin = margin(t = 0.2, unit = "cm")
        )

# print figure

Fig_PopData_v6.7

```


**Fig. 1 Senescence Validation and Population-Level Analysis**. **a**) Workflow for high-content image analysis of senescent cells. Primary human lung HMVEC-L endothelial cells and IMM-90 fibroblasts were mock treated (CTL) or induced to senescence using ionizing radiation (SEN). For both cell types, microplates were co-stained for senescence-associated markers (SA-B-Gal and EdU, or $\gamma$H2AX and LaminB1, HMBG1, or p21.  **b**) Representative images of primary human lung HMVEC-L endothelial cells and IMR-90 fibroblasts induced to senescence via ionizing radiation (IR) and mock-treated non-senescent controls (CTL). Cells were either cultured always in full serum (FS) or cultured in full serum until three days before sample collection and then switched to serum-starved conditions (SS). Samples were stained for the senescence-associated markers SA-$\beta$-Gal and EdU. **c**) Quantification of (a), showing percentages of SA-$\beta$-Gal- and EdU-positive cells per well (mean ± SD, n = 9). **d**) Representative ICC images of HMVEC-L and IMR-90 stained for $\gamma$H2AX in combination with other senescence-associated markers: HMGB1, Lamin B1, or p21.**e**) Quantification of (c), showing the relative changes in senescence markers expression between IR and CTL cells (mean fold change ± SD, n = 4). **f-h**) Quantification of nuclear morphological features: nuclear area (e), aspect ratio (ASP, f), and shape factor (SF) (mean ± SD, n = 12).

```{r save Fig1, eval=FALSE}

# png
save_png <- function(figure, name) {
  png(paste0("inst/figures/",name,"_", Sys.Date(), ".png"),
    width = 7.5,
    height = 10,
    units = "in",
    family = "sans",
    bg = "transparent", # doesn't work, bg is actually white
    res = 600)

  print(figure)
  
  dev.off()
}

# save_png(Fig_PopData_v6.2, "Fig_PopData_v6.2")
save_png(Fig_PopData_v6.7, "Fig_PopData_v6.7")

```

```{r Notes, eval=FALSE}

```

